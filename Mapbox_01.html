<!DOCTYPE html>
<html>
<head>
  <title>London Attraction Map</title>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.9.2/mapbox-gl.css" rel="stylesheet">
  <style>
    #title {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: #FFD700; /* é‡‘é»„è‰² */
      font-size: 2.0em;
      font-family: 'Arial Black', sans-serif;
      text-shadow: 0 0 5px rgba(255,215,0,0.7); /* å‘å…‰æ•ˆæœ */
      z-index: 1000;
      padding: 10px 20px;
      border-radius: 15px;
    }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    #menu {
      position: absolute;
      top: 100px; /* ä¸‹ç§»é¿å¼€æ ‡é¢˜ */
      left: 10px;
      background: rgba(0,0,0,0.7);
      padding: 15px;
      border-radius: 8px;
      color: white;
      z-index: 1000;
    }
    
    #type-filter {
      background: #333;
      color: #FFD700;
      border: 1px solid #FFD700;
      padding: 8px;
      border-radius: 5px;
    }
    
    /* å¼¹çª—é€æ˜èƒŒæ™¯ */
    .custom-popup .mapboxgl-popup-content {
      background: rgba(255, 255, 255, 0.95) !important;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      pointer-events: auto !important; /* å…è®¸ç‚¹å‡»å¼¹çª—å†…å®¹ */
    }
  </style>
</head>

<body>
  <div id="title">London Attractions Map</div>  

  <div id="menu">
    <select id="type-filter">
      <option value="all">all</option>
      <option value="museum">museum</option>
      <option value="gallery">gallery</option>
      <option value="attraction">attraction</option>
      <option value="theme_park">theme_park</option>
      <option value="viewpoint">viewpoint</option>
      <option value="zoo">zoo</option>
      <option value="artwork">artwork</option>
      <option value="aquarium">aquarium</option>
    </select>
  </div>
  <div id="map"></div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoieWwzIiwiYSI6ImNtN2txZGc2czAzYjMybXNka3ZsbTl5cmQifQ.kV4cU6Id_aGZM7R1HiudwA';
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/dark-v11',
      center: [-0.1278, 51.5074],
      zoom: 12
    });

    // åˆå§‹åŒ–å¼¹çª—
    const popup = new mapboxgl.Popup({
      closeButton: true,
      className: 'custom-popup',
      offset: [0, -20]
    });

    let currentPopup = null;
    let closeTimer;

    map.on('load', () => {
      map.addSource('attractions', {
        type: 'geojson',
        data: 'https://raw.githubusercontent.com/YULI61/visual_personal/main/filtered_london_attractions.geojson'
      });

      map.addLayer({
        id: 'attractions-layer',
        type: 'circle',
        source: 'attractions',
        paint: {
          'circle-radius': 8,
          'circle-color': '#ff0000',
          'circle-opacity': 0.8
        }
      });

      map.addSource('london-boundary', {
        type: 'geojson',
        data: 'london_boundary.geojson' // æ›¿æ¢ä¸ºä½ çš„æ–‡ä»¶è·¯å¾„æˆ–URL
});

      map.addLayer({
        id: 'london-boundary-layer',
        type: 'fill',
        source: 'london-boundary',
        paint: {
        'fill-color': 'rgba(200, 200, 200, 0.2)',
        'fill-outline-color': '#FFFFFF'
        }
}); 
        
        
        
      // ç­›é€‰åŠŸèƒ½
      document.getElementById('type-filter').addEventListener('change', (e) => {
        const selectedType = e.target.value;
        map.setFilter('attractions-layer', selectedType === 'all' ? null : ['==', ['get', 'type'], selectedType]);
      });

      // æ‚¬åœæ˜¾ç¤ºå¼¹çª—
      map.on('mouseenter', 'attractions-layer', (e) => {
        if (currentPopup) return;

        const props = e.features[0].properties;
        let html = `<h3 style="margin:0">${props.name}</h3>`;
        if (props.type) html += `<p style="color:#666">Type: ${props.type}</p>`;
        if (props.image) html += `<img src="${props.image}" style="max-width:200px; margin:10px 0">`;
        if (props.address) html += `<p>ğŸ“ ${props.address}</p>`;
        if (props.website) html += `<p>ğŸŒ <a href="${props.website}" target="_blank" style="color:#1a73e8">Website</a></p>`;
        if (props.wikipedia) {
          const [lang, page] = props.wikipedia.split(':');
          html += `<p>ğŸ“š <a href="https://${lang}.wikipedia.org/wiki/${page.replace(/ /g, '_')}" target="_blank" style="color:#1a73e8">Wikipedia</a></p>`;
        }

        currentPopup = popup.setLngLat(e.lngLat).setHTML(html);
        currentPopup.addTo(map);
      });

      // å»¶è¿Ÿå…³é—­å¼¹çª—
      map.on('mouseleave', 'attractions-layer', () => {
        closeTimer = setTimeout(() => {
          currentPopup?.remove();
          currentPopup = null;
        }, 300);
      });

      // å–æ¶ˆå…³é—­ï¼ˆå½“é¼ æ ‡è¿›å…¥å¼¹çª—ï¼‰
      document.addEventListener('mouseover', (e) => {
        if (e.target.closest('.mapboxgl-popup-content')) {
          clearTimeout(closeTimer);
        }
      });

      // ç‚¹å‡»åœ°å›¾ç©ºç™½å¤„å…³é—­
      map.on('click', (e) => {
        if (!e.features?.length) {
          currentPopup?.remove();
          currentPopup = null;
        }
      });
    }); // <-- é—­åˆ map.on('load')
  </script>
</body>
</html>